---
sidebar_position: 5
slug: /system_configuration/2.5_CPP_Usage
---

# 2.5 C++ ä½¿ç”¨æŒ‡å—

## å‰è¨€

### æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£æ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›åœ¨ **SpacemiT RISC-V64** åŸç”Ÿæœºå™¨ä¸Šè¿›è¡Œ C++ å¼€å‘çš„å®Œæ•´ä½¿ç”¨è¯´æ˜ã€‚å†…å®¹æ¶µç›–ä»å¼€å‘ç¯å¢ƒå‡†å¤‡ã€ç¼–è¯‘ä¸æ„å»ºæ–¹æ³•ã€å¸¸è§åº“çš„ä½¿ç”¨ï¼Œåˆ°é¢å‘ RISC-V64 å¹³å°çš„æ€§èƒ½ä¼˜åŒ–ä¸è°ƒè¯•æŠ€å·§ã€‚
 æœ¬è¯´æ˜æ–‡æ¡£çš„ç›®æ ‡æ˜¯ï¼š

- å¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ­å»ºå¹¶éªŒè¯ C++ å¼€å‘ç¯å¢ƒï¼›
- æŒ‡å¯¼å¼€å‘è€…åœ¨ RISC-V64 å¹³å°ä¸Šæ­£ç¡®ç¼–è¯‘ã€è¿è¡Œã€è°ƒè¯• C++ ç¨‹åºï¼›
- æä¾› RISC-V64 å¹³å°ç›¸å…³çš„ç¼–è¯‘é€‰é¡¹ã€æŒ‡ä»¤é›†ä¼˜åŒ–å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼›
- ä¸ºåç»­è¿›è¡Œé«˜æ€§èƒ½è®¡ç®—ã€ç³»ç»Ÿç¼–ç¨‹ã€AI/æœºå™¨äººå¼€å‘ç­‰æä¾›åŸºç¡€æ”¯æ’‘ã€‚

### é€‚ç”¨ç¯å¢ƒ

æœ¬è¯´æ˜é€‚ç”¨äºè¿è¡Œåœ¨ **SpacemiT RISC-V64 æ¶æ„å¤„ç†å™¨** ä¸Šçš„åŸç”Ÿ Linux æ“ä½œç³»ç»Ÿç¯å¢ƒï¼Œæ¨èä½¿ç”¨ ROS2_LXQT å’Œå…¶ä»–ç±»ä¼¼å‘è¡Œç‰ˆï¼š

- **ROS2_LXQT (æ¨è)**
- **Bianbu RISC-V (24.04 åŠä»¥ä¸Š)**
- å…¶ä»–å…¼å®¹ RISC-V64 çš„ Linux å‘è¡Œç‰ˆï¼ˆå¦‚ Fedora RISC-Vã€openEuler RISC-Vã€Arch RISC-V ç­‰ï¼‰

è¿è¡Œç¯å¢ƒçš„ä¸€èˆ¬è¦æ±‚ï¼š

- ç³»ç»Ÿå·²é¢„è£…æˆ–å¯é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£… `g++`ã€`make`ã€`cmake` ç­‰å¸¸ç”¨æ„å»ºå·¥å…·
- ç³»ç»Ÿæä¾›æ ‡å‡† C åº“ï¼ˆglibc æˆ– muslï¼‰å’Œ C++ æ ‡å‡†åº“ï¼ˆlibstdc++ï¼‰
- ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œä»¥ä¾¿é€šè¿‡ `apt`ã€`dnf`ã€`pacman` ç­‰å·¥å…·å®‰è£…ä¾èµ–åº“

------

## å¼€å‘ç¯å¢ƒå‡†å¤‡

### ç¼–è¯‘å™¨

#### GCC/G++ for ROS2_LXQT

- **çŠ¶æ€**ï¼šGCC åœ¨ ROS2_LXQTä¸Šå·²ç»æœ‰æˆç†Ÿæ”¯æŒï¼Œå…¶ä»– Bianbu ç³»ç»Ÿçš„ä½¿ç”¨æ–¹æ³•ç›¸åŒã€‚

- **å®‰è£…**ï¼š

  ```bash
  sudo apt update
  sudo apt install build-essential g++ gcc
  ```

- **å¸¸ç”¨ç¼–è¯‘å‚æ•°**ï¼š

  - `-O2/-O3/-Ofast` â†’ ä¼˜åŒ–ç­‰çº§
  - `-march=rv64gc` â†’ æŒ‡å®š RISC-V åŸºç¡€æŒ‡ä»¤é›†
  - `-march=rv64gcv` â†’ å¯ç”¨å‘é‡æ‰©å±•

#### Clang/LLVM æ”¯æŒæƒ…å†µ

- Clang/LLVM çš„æ”¯æŒå·²è¿›å…¥ä¸»çº¿ï¼Œä½†æŸäº›ä¼˜åŒ–/æ‰©å±•å¯èƒ½ä¸å¦‚ GCC å®Œå–„ã€‚

- å¯é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…ï¼š

  ```bash
  sudo apt install clang
  ```

- ä½¿ç”¨æ—¶å¯é€šè¿‡ `clang++` æ›¿ä»£ `g++` è¿›è¡Œç¼–è¯‘ã€‚

#### éªŒè¯ç¼–è¯‘å™¨ç‰ˆæœ¬

```bash
g++ --version
clang++ --version
```

ç¡®è®¤è¾“å‡ºä¸­åŒ…å« `riscv64` æˆ–æ­£ç¡®çš„ç‰ˆæœ¬å·ã€‚

------

### æ ‡å‡†åº“

#### libstdc++ çŠ¶æ€

- `libstdc++` æ˜¯ **GNU æä¾›çš„ C++ æ ‡å‡†åº“**ã€‚å®ƒä¸»è¦ç”¨äºæ”¯æŒ C++ è¯­è¨€çš„æ ‡å‡†ç‰¹æ€§å’Œåº“å‡½æ•°ï¼Œ åŒ…æ‹¬ï¼š å®¹å™¨ç±»ã€ç®—æ³•ã€ å­—ç¬¦ä¸²ç±»ã€ æµå’ŒIO ã€æ™ºèƒ½æŒ‡é’ˆã€ å¼‚å¸¸å¤„ç†ã€ çº¿ç¨‹å’Œå¹¶å‘ã€‚

- ç¡®è®¤æ–¹æ³•ï¼š

  ```bash
  dpkg -L libstdc++6
  ```

#### glibc æƒ…å†µ

- **glibc** æ˜¯ **GNU C Library**ï¼Œä¹Ÿå°±æ˜¯ **GNU æä¾›çš„ C æ ‡å‡†åº“**ï¼Œå®ƒå’Œ `libstdc++` ç±»ä¼¼ï¼Œä½†é’ˆå¯¹ **C è¯­è¨€**ï¼ŒåŒæ—¶ä¸º C++ æä¾›åº•å±‚æ”¯æŒ

- **ROS2_LXQT** ä½¿ç”¨ glibc

- æŸ¥çœ‹ä¿¡æ¯ï¼š

  ```bash
  ldd --version
  ```

#### å¸¸ç”¨å¼€å‘å¤´æ–‡ä»¶è·¯å¾„

- ç³»ç»Ÿæ ‡å‡†è·¯å¾„ï¼š
  - `/usr/include/`
  - `/usr/lib/riscv64-linux-gnu/` ï¼ˆåº“æ–‡ä»¶ï¼‰
  - `/usr/include/c++/<ç‰ˆæœ¬å·>/` ï¼ˆC++ å¤´æ–‡ä»¶ï¼‰

------

### æ„å»ºå·¥å…·

#### make

- æœ€å¸¸è§çš„æ„å»ºå·¥å…·ã€‚

- å®‰è£…ï¼š

  ```bash
  sudo apt install make
  ```

#### cmake

- å¸¸ç”¨çš„è·¨å¹³å°æ„å»ºç³»ç»Ÿç”Ÿæˆå™¨ã€‚

- å®‰è£…ï¼š

  ```bash
  sudo apt install cmake
  ```

#### ninja

- æ›´é«˜æ•ˆçš„æ„å»ºå·¥å…·ï¼Œå¸¸ä¸ CMake é…åˆä½¿ç”¨ï¼ˆ`cmake -G Ninja`ï¼‰ã€‚

- å®‰è£…ï¼š

  ```bash
  sudo apt install ninja-build
  ```

------

### è°ƒè¯•ä¸æ€§èƒ½å·¥å…·

#### gdb

- GNU Debuggerï¼Œæ”¯æŒ ROS2_LXQTã€‚

- å®‰è£…ï¼š

  ```bash
  sudo apt install gdb
  ```

- å¸¸ç”¨å‘½ä»¤ï¼š`break`ã€`run`ã€`next`ã€`print`ã€`info registers`

#### perf

- Linux çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œå¯åˆ†æ CPU æŒ‡ä»¤ã€ç¼“å­˜ã€åˆ†æ”¯é¢„æµ‹ç­‰ã€‚

- å®‰è£…ï¼š

  ```
  sudo apt install linux-tools-common linux-tools-$(uname -r)
  ```

- æ£€æŸ¥æ˜¯å¦å¯ç”¨ï¼š

  ```bash
  perf stat ls
  ```

ä½¿ç”¨æ•™ç¨‹è§ï¼š[perf ä½¿ç”¨æ•™ç¨‹](https://bianbu.spacemit.com/en/brdk/Advanced_development/7.2_perf)

------

## C++ åŸºç¡€ä½¿ç”¨

### Hello World ç¨‹åº

æœ€åŸºç¡€çš„ C++ ç¤ºä¾‹ç¨‹åºï¼Œå¯ä»¥éªŒè¯ç¼–è¯‘å™¨å’Œç¯å¢ƒæ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

```cpp
#include <iostream>

int main() {
    std::cout << "Hello, SpacemiT RISC-V64!" << std::endl;
    return 0;
}
```

#### ç¼–è¯‘ä¸è¿è¡Œ

åœ¨ ROS2_LXQT ä¸Šï¼Œä½¿ç”¨ GCC ç¼–è¯‘ï¼š

```bash
g++ hello.cpp -o hello
./hello
```

è¾“å‡ºåº”ä¸ºï¼š

```
Hello, SpacemiT RISC-V64!
```

> ğŸ’¡ æç¤ºï¼šå¦‚æœå‡ºç° `g++: command not found`ï¼Œè¯·å…ˆç¡®è®¤ GCC/G++ å·²å®‰è£…ï¼Œå¹¶åœ¨ `$PATH` ä¸­ã€‚

------

### è¯­è¨€æ ‡å‡†é€‰æ‹©

C++ è¯­è¨€æ ‡å‡†å½±å“å¯ç”¨ç‰¹æ€§å’Œåº“å‡½æ•°ã€‚GCC/Clang åœ¨ ROS2_LXQT ä¸Šå¯¹ä»¥ä¸‹æ ‡å‡†æ”¯æŒè¾ƒå¥½ï¼š

- `-std=c++11`ï¼šåŸºç¡€è¯­æ³•ã€lambdaã€æ™ºèƒ½æŒ‡é’ˆç­‰ã€‚
- `-std=c++14`ï¼šæ›´çµæ´»çš„ lambdaã€æ³›å‹ç¼–ç¨‹æ”¹è¿›ã€‚
- `-std=c++17`ï¼šç»“æ„åŒ–ç»‘å®šã€if åˆå§‹åŒ–è¯­å¥ã€æ–‡ä»¶ç³»ç»Ÿåº“ã€‚
- `-std=c++20`ï¼šæ¦‚å¿µï¼ˆconceptï¼‰ã€åç¨‹ï¼ˆcoroutineï¼‰ã€ranges åº“ã€‚
- `-std=c++23`ï¼šæœ€æ–°æ ‡å‡†ï¼Œéƒ¨åˆ†ç‰¹æ€§ä»åœ¨ç¼–è¯‘å™¨å®ç°ä¸­ã€‚

**ä½¿ç”¨ç¤ºä¾‹**

```bash
g++ -std=c++17 hello.cpp -o hello
```

> âš ï¸ æ³¨æ„ï¼šSpacemiT RISC-V64 å¹³å°å¯¹æ–°æ ‡å‡†çš„æ”¯æŒå–å†³äº GCC/Clang ç‰ˆæœ¬ï¼Œè¾ƒæ—§å‘è¡Œç‰ˆå¯èƒ½ä¸å®Œå…¨æ”¯æŒ C++20/23ã€‚

------

### ç¼–è¯‘ä¼˜åŒ–

ç¼–è¯‘ä¼˜åŒ–å½±å“ç¨‹åºæ€§èƒ½å’Œå¤§å°ï¼Œå¯æ ¹æ®éœ€æ±‚é€‰æ‹©ä¸åŒé€‰é¡¹ã€‚

#### å¸¸ç”¨ä¼˜åŒ–ç­‰çº§

| é€‰é¡¹     | å«ä¹‰                                    |
| -------- | --------------------------------------- |
| `-O0`    | ä¸ä¼˜åŒ–ï¼Œä¾¿äºè°ƒè¯•                        |
| `-O2`    | å¸¸ç”¨ä¼˜åŒ–ï¼Œå¹³è¡¡ç¼–è¯‘æ—¶é—´å’Œæ€§èƒ½            |
| `-O3`    | æ¿€è¿›ä¼˜åŒ–ï¼Œå¯èƒ½å¢åŠ ä»£ç å¤§å°              |
| `-Ofast` | æ¿€è¿›ä¼˜åŒ– + ä¸å®Œå…¨éµå®ˆæ ‡å‡†ï¼Œè¿½æ±‚æœ€é«˜æ€§èƒ½ |

#### RISC-V ç‰¹å®šé€‰é¡¹

- `-march=rv64gc`ï¼šå¯ç”¨ RISC-V 64 ä½åŸºæœ¬æ•´æ•° + å‹ç¼© + æµ®ç‚¹ + åŸå­æŒ‡ä»¤é›†
- `-march=rv64gcv`ï¼šå¯ç”¨å‘é‡æ‰©å±•ï¼ˆRVVï¼‰

#### é“¾æ¥æ—¶ä¼˜åŒ–

- `-flto`ï¼ˆLink Time Optimizationï¼‰ï¼šåœ¨é“¾æ¥é˜¶æ®µè¿›ä¸€æ­¥ä¼˜åŒ–æ•´ä¸ªç¨‹åºã€‚

```bash
g++ -O3 -march=rv64gc -flto hello.cpp -o hello
```

> ğŸ’¡ æç¤ºï¼šæ¿€è¿›ä¼˜åŒ–å¯èƒ½æ”¹å˜ç¨‹åºè¡Œä¸ºæˆ–ä½¿è°ƒè¯•å›°éš¾ï¼Œè°ƒè¯•é˜¶æ®µå»ºè®®ä½¿ç”¨ `-O0`ã€‚

------

### å¸¸è§ç¼–è¯‘é”™è¯¯ä¸è§£å†³æ–¹æ³•

åœ¨  SpacemiT RISC-V64 å¹³å°ä¸Šå¼€å‘ C++ ç¨‹åºæ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹å¸¸è§ç¼–è¯‘é”™è¯¯ï¼š

#### `g++: command not found`

**åŸå› **ï¼šç³»ç»Ÿæœªå®‰è£… GCC/G++ã€‚
 **è§£å†³æ–¹æ³•**ï¼š

```bash
sudo apt update
sudo apt install build-essential g++
```

#### `error: unrecognized command line option '-march=...'`

**åŸå› **ï¼šå½“å‰ GCC ç‰ˆæœ¬ä¸æ”¯æŒæŒ‡å®šçš„ RISC-V æŒ‡ä»¤é›†æ‰©å±•ã€‚
 **è§£å†³æ–¹æ³•**ï¼š

- æŸ¥çœ‹æ”¯æŒçš„ `-march` é€‰é¡¹ï¼š

```bash
riscv64-linux-gnu-g++ -march=rv64g -E -v -
```

- ä½¿ç”¨å‘è¡Œç‰ˆæä¾›çš„é»˜è®¤æ”¯æŒæŒ‡ä»¤é›†ï¼ˆå¦‚ `-march=rv64gc`ï¼‰ã€‚
- å¿…è¦æ—¶å‡çº§ GCC æˆ–ä½¿ç”¨ RISC-V å®˜æ–¹å·¥å…·é“¾ã€‚

#### `undefined reference to 'std::...'`

**åŸå› **ï¼šC++ æ ‡å‡†åº“æœªæ­£ç¡®é“¾æ¥æˆ–å¤´æ–‡ä»¶è·¯å¾„ä¸åŒ¹é…ã€‚
 **è§£å†³æ–¹æ³•**ï¼š

- ç¡®è®¤å®‰è£…äº† `libstdc++`ï¼š

```bash
dpkg -L libstdc++6
```

- ç¡®è®¤ç¼–è¯‘å™¨ä½¿ç”¨çš„æ ‡å‡†åº“è·¯å¾„æ­£ç¡®ï¼š

```bash
g++ -v hello.cpp
```

#### æ ‡å‡†ä¸å…¼å®¹é”™è¯¯

**ç¤ºä¾‹**ï¼š

```
error: 'concept' requires C++20
```

**åŸå› **ï¼šä½¿ç”¨çš„è¯­è¨€ç‰¹æ€§é«˜äºç¼–è¯‘å™¨é»˜è®¤æ ‡å‡†ã€‚
 **è§£å†³æ–¹æ³•**ï¼š

- æŒ‡å®šæ­£ç¡®çš„æ ‡å‡†ï¼š

```bash
g++ -std=c++20 hello.cpp -o hello
```

- å¦‚æœç¼–è¯‘å™¨ç‰ˆæœ¬è¿‡æ—§ï¼Œä¸æ”¯æŒæ–°æ ‡å‡†ï¼Œåˆ™å‡çº§ GCC æˆ– Clangã€‚

#### æ€§èƒ½ä¼˜åŒ–å¯¼è‡´è¡Œä¸ºå¼‚å¸¸

**ç¤ºä¾‹**ï¼š`-Ofast` ç¼–è¯‘åç¨‹åºè¾“å‡ºå¼‚å¸¸æˆ–å´©æºƒã€‚
 **åŸå› **ï¼š`-Ofast` å¯èƒ½æ”¾å®½äº†æ ‡å‡†çº¦æŸï¼Œæµ®ç‚¹è¿ç®—ã€æœªå®šä¹‰è¡Œä¸ºå¯èƒ½å—å½±å“ã€‚
 **è§£å†³æ–¹æ³•**ï¼š

- è°ƒè¯•é˜¶æ®µä½¿ç”¨ `-O0` æˆ– `-O2`
- ä»”ç»†æ£€æŸ¥æŒ‡é’ˆã€æ•°ç»„è¶Šç•Œã€æœªåˆå§‹åŒ–å˜é‡ç­‰æ½œåœ¨é—®é¢˜

#### æç¤º(ç¼–è¯‘é”™è¯¯ä¸è§£å†³æ–¹æ³•)

- å‡ºç°é”™è¯¯æ—¶å…ˆç¡®è®¤ç¼–è¯‘å™¨ç‰ˆæœ¬å’Œå¹³å°æŒ‡ä»¤é›†æ”¯æŒ
- RISC-V64 å¹³å°ç›¸æ¯” x86ï¼ŒæŸäº›ä¼˜åŒ–æˆ–åº“å‡½æ•°è¡Œä¸ºå¯èƒ½ç•¥æœ‰ä¸åŒ
- å¯¹äºå¤æ‚é¡¹ç›®ï¼Œå»ºè®®ä½¿ç”¨ CMake æˆ– Makefile ç®¡ç†ç¼–è¯‘é€‰é¡¹ï¼Œç»Ÿä¸€æ ‡å‡†å’Œä¼˜åŒ–ç­‰çº§

------

## RISC-V64 ç‰¹æ€§ä¸ä¼˜åŒ–

### æŒ‡ä»¤é›†æ‰©å±•

RISC-V64 å¹³å°çš„æ€§èƒ½å’ŒåŠŸèƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºæ‰€å¯ç”¨çš„æŒ‡ä»¤é›†æ‰©å±•ã€‚

#### å¸¸ç”¨æ‰©å±•

- **RV64G** (`-march=rv64gc`)
  - åŸºç¡€æ•´æ•°æŒ‡ä»¤ï¼ˆIï¼‰
  - åŸå­æŒ‡ä»¤ï¼ˆAï¼‰
  - æµ®ç‚¹æŒ‡ä»¤ï¼ˆF/Dï¼‰
  - å‹ç¼©æŒ‡ä»¤ï¼ˆCï¼‰
  - è¿™æ˜¯æœ€å¸¸ç”¨çš„é€šç”¨æ‰©å±•ç»„åˆï¼Œé€‚åˆå¤§å¤šæ•°åº”ç”¨
- **å‘é‡æ‰©å±•ï¼ˆRVVï¼‰**
  - æ‰©å±•æ ‡è®° `v`ï¼Œå¯ç”¨ `-march=rv64gcv` å¯ç”¨
  - æ”¯æŒ SIMD é£æ ¼çš„å‘é‡è¿ç®—ï¼Œé€‚åˆçŸ©é˜µè¿ç®—ã€AI æ¨ç†ç­‰é«˜æ€§èƒ½è®¡ç®—
  - æ³¨æ„ï¼šç¡¬ä»¶å’Œå·¥å…·é“¾å¿…é¡»æ”¯æŒ RVV

#### ç¼–è¯‘å™¨å‚æ•°ç¤ºä¾‹

```bash
g++ -march=rv64gcv -O3 vec_test.cpp -o vec_test
```

- `-O3`ï¼šæ¿€è¿›ä¼˜åŒ–
- `-march=rv64gcv`ï¼šå¯ç”¨é€šç”¨ + å‹ç¼© + å‘é‡æ‰©å±•

#### RVVæµ‹è¯•å®ä¾‹

åœ¨ä½¿ç”¨ RVV å‰ï¼Œå»ºè®®å°† GCC å‡çº§åˆ° 14 åŠä»¥ä¸Šï¼Œç²˜è´´å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
GCC_MAJOR=$(gcc -dumpfullversion | cut -d. -f1)

if [ "$GCC_MAJOR" -lt 14 ]; then
    echo "å½“å‰ GCC ç‰ˆæœ¬ä¸º $GCC_MAJORï¼Œå°äº 14ï¼Œå¼€å§‹å®‰è£… gcc-14 å’Œ g++-14..."

    sudo apt install -y gcc-14 g++-14

    # è®¾ç½® update-alternatives
    sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
    sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
    sudo update-alternatives --set gcc /usr/bin/gcc-14
    sudo update-alternatives --set g++ /usr/bin/g++-14

    sudo update-alternatives --install /usr/bin/riscv64-linux-gnu-gcc riscv64-linux-gnu-gcc /usr/bin/riscv64-linux-gnu-gcc-14 100
    sudo update-alternatives --install /usr/bin/riscv64-linux-gnu-g++ riscv64-linux-gnu-g++ /usr/bin/riscv64-linux-gnu-g++-14 100
    sudo update-alternatives --set riscv64-linux-gnu-gcc /usr/bin/riscv64-linux-gnu-gcc-14
    sudo update-alternatives --set riscv64-linux-gnu-g++ /usr/bin/riscv64-linux-gnu-g++-14

    echo "âœ… GCC/G++ å·²åˆ‡æ¢ä¸º 14"
else
    echo "âœ… å½“å‰ GCC ç‰ˆæœ¬ä¸º $GCC_MAJORï¼Œå·²æ»¡è¶³ â‰¥ 14ï¼Œæ— éœ€åˆ‡æ¢"
fi
```

**æµ‹è¯•ç¨‹åºï¼š**

```cpp
#include <stdio.h>

#if !defined(__riscv) || !defined(__riscv_v)
#error "RISC-V or vector extension(RVV) is not supported by the compiler"
#endif

#if !defined(__THEAD_VERSION__) && defined(__riscv_v_intrinsic) && __riscv_v_intrinsic < 12000
#error "Wrong intrinsics version, v0.12 or higher is required for gcc or clang"
#endif

#include <riscv_vector.h>

#ifdef __THEAD_VERSION__
int test()
{
    const float src[] = { 0.0f, 0.0f, 0.0f, 0.0f };
    uint64_t ptr[2] = {0x0908060504020100, 0xFFFFFFFF0E0D0C0A};
    vuint8m1_t a = vreinterpret_v_u64m1_u8m1(vle64_v_u64m1(ptr, 2));
    vfloat32m1_t val = vle32_v_f32m1((const float*)(src), 4);
    return (int)vfmv_f_s_f32m1_f32(val);
}
#else
int test()
{
    const float src[] = { 0.0f, 0.0f, 0.0f, 0.0f };
    uint64_t ptr[2] = {0x0908060504020100, 0xFFFFFFFF0E0D0C0A};
    vuint8m1_t a = __riscv_vreinterpret_v_u64m1_u8m1(__riscv_vle64_v_u64m1(ptr, 2));
    vfloat32m1_t val = __riscv_vle32_v_f32m1((const float*)(src), 4);
    return (int)__riscv_vfmv_f_s_f32m1_f32(val);
}
#endif

int main()
{
  printf("%d\n", test());
  return 0;
}
```

ä¿å­˜ä¸º `cpu_rvv.cpp`

æ‰§è¡Œç¼–è¯‘ï¼š

```bash
g++ -march=rv64gcv -mabi=lp64d cpu_rvv.cpp -o cpu_rvv
```

åæ±‡ç¼–ï¼š

```CMake
objdump -d cpu_rvv | grep '^ *[0-9a-f]*:.*v'
```

![](./images/rvv.png)

å¸¦`.v` çš„å³ä¸º v æŒ‡ä»¤

------

## å·¥ç¨‹ç®¡ç†

åœ¨ ROS2_LXQT å¹³å°è¿›è¡Œ C++ å¼€å‘æ—¶ï¼Œä½¿ç”¨åˆé€‚çš„æ„å»ºç³»ç»Ÿå¯ä»¥æœ‰æ•ˆç®¡ç†æºæ–‡ä»¶ã€ä¾èµ–åº“å’Œç¼–è¯‘é€‰é¡¹ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚å¸¸ç”¨æ„å»ºå·¥å…·åŒ…æ‹¬ **Makefile** å’Œ **CMake**ã€‚

------

### Makefile ç¤ºä¾‹

#### ç®€å•å•æ–‡ä»¶å·¥ç¨‹

Makefile

```makefile
# å˜é‡å®šä¹‰
CXX = g++
CXXFLAGS = -O2 -march=rv64gc -std=c++17
TARGET = hello
SRCS = hello.cpp

# é»˜è®¤ç›®æ ‡
all: $(TARGET)

# é“¾æ¥ç›®æ ‡
$(TARGET): $(SRCS)
	$(CXX) $(CXXFLAGS) $^ -o $@

# æ¸…ç†
clean:
	rm -f $(TARGET)
```

**è¯´æ˜**ï¼š

- `$^`ï¼šè¡¨ç¤ºæ‰€æœ‰ä¾èµ–æ–‡ä»¶
- `$@`ï¼šè¡¨ç¤ºç›®æ ‡æ–‡ä»¶
- `CXXFLAGS`ï¼šå¯ä»¥åŒ…å«ä¼˜åŒ–ç­‰çº§ã€è¯­è¨€æ ‡å‡†å’Œ RISC-V ç‰¹å®šæŒ‡ä»¤é›†

**ä½¿ç”¨ï¼š**

```bash
make        # ç¼–è¯‘
make clean  # åˆ é™¤ç”Ÿæˆæ–‡ä»¶
```

#### å¤šæ–‡ä»¶å·¥ç¨‹

```makefile
CXX = g++
CXXFLAGS = -O2 -march=rv64gc -std=c++17
TARGET = my_app
SRCS = main.cpp utils.cpp
OBJS = $(SRCS:.cpp=.o)

all: $(TARGET)

$(TARGET): $(OBJS)
	$(CXX) $(CXXFLAGS) $^ -o $@

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

clean:
	rm -f $(OBJS) $(TARGET)
```

> ğŸ’¡ æç¤ºï¼šMakefile çš„ä¾èµ–å…³ç³»å¯ä»¥æ ¹æ®å¤´æ–‡ä»¶å˜åŒ–è‡ªåŠ¨æ›´æ–°ï¼Œä¿è¯å¢é‡ç¼–è¯‘é«˜æ•ˆã€‚

------

### CMake ç¤ºä¾‹

CMake æ˜¯è·¨å¹³å°æ„å»ºå·¥å…·ï¼Œæ›´é€‚åˆå¤§å‹æˆ–å¤šç›®å½•å·¥ç¨‹ã€‚

#### å•æ–‡ä»¶å·¥ç¨‹

**`CMakeLists.txt`**

```cmake
cmake_minimum_required(VERSION 3.16)
project(HelloRISCVDemo CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_FLAGS "-O2 -march=rv64gc")

add_executable(hello hello.cpp)
```

**æ„å»ºï¼š**

```bash
mkdir build && cd build
cmake ..
make
./hello
```

#### å¤šç›®å½•å·¥ç¨‹

ç›®å½•ç»“æ„ï¼š

```
my_app/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.cpp
â”‚   â””â”€â”€ utils.cpp
â””â”€â”€ include/
    â””â”€â”€ utils.h
```

**é¡¶å±‚ `CMakeLists.txt`**

```cmake
cmake_minimum_required(VERSION 3.16)
project(MyApp CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_FLAGS "-O2 -march=rv64gc")

add_subdirectory(src)
include_directories(include)
```

**`src/CMakeLists.txt`**

```cmake
add_executable(my_app main.cpp utils.cpp)
```

æ„å»ºåŒæ ·åœ¨ `build` ç›®å½•ä¸‹æ‰§è¡Œï¼š

```bash
cmake ..
make
```

#### ä¸ pkg-config é…åˆ

å¦‚æœä½¿ç”¨å¤–éƒ¨åº“ï¼ˆå¦‚ `glib`ã€`SDL2`ï¼‰ï¼š

```cmake
find_package(PkgConfig REQUIRED)
pkg_check_modules(GLIB REQUIRED glib-2.0)
include_directories(${GLIB_INCLUDE_DIRS})
link_directories(${GLIB_LIBRARY_DIRS})
add_executable(my_app main.cpp)
target_link_libraries(my_app ${GLIB_LIBRARIES})
```

#### CMake æç¤º

- CMake æ”¯æŒå¤šå¹³å°ï¼Œå¯è½»æ¾åˆ‡æ¢ RISC-V64 æˆ– x86 æ„å»ºé€‰é¡¹
- ä½¿ç”¨ `pkg-config` å¯ä»¥æ–¹ä¾¿ç®¡ç†ç¬¬ä¸‰æ–¹åº“ä¾èµ–

------

## å¸¸ç”¨åº“

æœ¬ç« èŠ‚ç¤ºä¾‹å¤šæ•°ç›´æ¥ä½¿ç”¨ `g++` ç¼–è¯‘ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ cmake ç­‰æ¥ç®¡ç†ç¼–è¯‘æµç¨‹ã€‚

### ç³»ç»Ÿåº“

#### pthread

ç¤ºä¾‹ä»£ç  `pthread_test.cpp`ï¼š

```cpp
#include <pthread.h>
#include <iostream>

void* thread_func(void* arg) {
    std::cout << "Hello from thread!" << std::endl;
    return nullptr;
}

int main() {
    pthread_t tid;
    pthread_create(&tid, nullptr, thread_func, nullptr);
    pthread_join(tid, nullptr);
}
```

**ç¼–è¯‘ä¸è¿è¡Œ**ï¼š

```bash
g++ -std=c++17 -O2 -march=rv64gc pthread_test.cpp -o pthread_test -lpthread
./pthread_test
```

------

#### dlopen / dlsym

ç¤ºä¾‹ä»£ç  `dl_test.cpp`ï¼š

```cpp
#include <dlfcn.h>
#include <iostream>

int main() {
    void* handle = dlopen("libm.so", RTLD_LAZY);
    if (!handle) { std::cerr << dlerror(); return 1; }
    double (*cos_func)(double) = (double(*)(double))dlsym(handle, "cos");
    std::cout << cos_func(0.0) << std::endl;
    dlclose(handle);
}
```

**ç¼–è¯‘ä¸è¿è¡Œ**ï¼š

```bash
g++ -std=c++17 -O2 -march=rv64gc dl_test.cpp -o dl_test -ldl
./dl_test
```

------

### æ•°å­¦ / ç§‘å­¦è®¡ç®—åº“

#### OpenBLAS

```
sudo apt install libopenblas-dev
```

ç¤ºä¾‹ä»£ç  `blas_test.cpp`ï¼š

```cpp
#include <cblas.h>
#include <iostream>

int main() {
    double A[4] = {1,2,3,4};
    double B[4] = {5,6,7,8};
    double C[4];
    cblas_dgemm(CblasRowMajor, CblasNoTrans, CblasNoTrans, 2, 2, 2, 1.0, A, 2, B, 2, 0.0, C, 2);
    std::cout << "C[0] = " << C[0] << std::endl;
}
```

**ç¼–è¯‘ä¸è¿è¡Œ**ï¼š

```bash
g++ -std=c++17 -O3 -march=rv64gcv blas_test.cpp -o blas_test -lopenblas
./blas_test
```

------

#### Eigen

```
sudo apt install libeigen3-dev
```

ç¤ºä¾‹ä»£ç  `eigen_test.cpp`ï¼š

```cpp
#include <Eigen/Dense>
#include <iostream>

int main() {
    Eigen::Matrix2d A;
    A << 1,2,3,4;
    std::cout << A << std::endl;
}
```

**ç¼–è¯‘ä¸è¿è¡Œ**ï¼š

```bash
g++ -std=c++17 -O2 -march=rv64gc -I/usr/include/eigen3 eigen_test.cpp -o eigen_test
./eigen_test
```

> Eigen æ˜¯å¤´æ–‡ä»¶åº“ï¼Œæ— éœ€é¢å¤–é“¾æ¥åº“

------

### ç½‘ç»œä¸ç³»ç»Ÿç¼–ç¨‹

#### POSIX Socket

ç¤ºä¾‹ä»£ç  `socket_test.cpp`ï¼š

```cpp
#include <sys/socket.h>
#include <netinet/in.h>
#include <iostream>

int main() {
    int sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0) std::cerr << "Socket creation failed" << std::endl;
    else std::cout << "Socket created successfully" << std::endl;
}
```

**ç¼–è¯‘ä¸è¿è¡Œ**ï¼š

```bash
g++ -std=c++17 -O2 -march=rv64gc socket_test.cpp -o socket_test
./socket_test
```

#### Boost (Asio ç¤ºä¾‹)

```
sudo apt install libboost-system-dev libboost-thread-dev
```

ç¤ºä¾‹ä»£ç  `boost_test.cpp`ï¼š

```cpp
#include <boost/asio.hpp>
#include <iostream>

int main() {
    boost::asio::io_context io;
    std::cout << "Boost Asio io_context created" << std::endl;
}
```

**ç¼–è¯‘ä¸è¿è¡Œ**ï¼š

```bash
g++ -std=c++17 -O2 -march=rv64gc boost_test.cpp -o boost_test -lboost_system -pthread
./boost_test
```

------

### å›¾å½¢ / ç•Œé¢

#### Qt5

```
sudo apt install qtbase5-dev
```

ç¤ºä¾‹ä»£ç  `qt_test.cpp`ï¼š

```cpp
#include <QApplication>
#include <QPushButton>

int main(int argc, char** argv) {
    QApplication app(argc, argv);
    QPushButton button("Hello RISC-V Qt");
    button.show();
    return app.exec();
}
```

**ç¼–è¯‘ä¸è¿è¡Œ**ï¼š

æ³¨æ„ï¼šåœ¨æœ¬æœºä¸Šæ¥å…¥å±å¹•æ‰å¯æˆåŠŸè¿è¡Œï¼Œsshè¿œç¨‹ç»ˆç«¯æ— æ³•æ˜¾ç¤º

```bash
g++ -std=c++17 -O2 -march=rv64gc qt_test.cpp -o qt_test $(pkg-config --cflags --libs Qt5Widgets)
./qt_test
```

------

#### SDL2

ç¤ºä¾‹ä»£ç  `sdl_test.cpp`ï¼š

```cpp
#include <SDL2/SDL.h>
#include <iostream>

int main() {
    if (SDL_Init(SDL_INIT_VIDEO) != 0) {
        std::cerr << "SDL_Init Error: " << SDL_GetError() << std::endl;
        return 1;
    }
    std::cout << "SDL initialized successfully" << std::endl;
    SDL_Quit();
}
```

**ç¼–è¯‘ä¸è¿è¡Œ**ï¼š

æ³¨æ„ï¼šåœ¨æœ¬æœºä¸Šæ¥å…¥å±å¹•æ‰å¯æˆåŠŸè¿è¡Œ

```bash
g++ -std=c++17 -O2 -march=rv64gc sdl_test.cpp -o sdl_test $(sdl2-config --cflags --libs)
./sdl_test
```



## æ›´å¤šä½¿ç”¨ç¤ºä¾‹

### C/C++ä½¿ç”¨GPIO

å¼•è„šå®šä¹‰å‚è€ƒï¼š[å¼•è„šå®šä¹‰](https://bianbu.spacemit.com/development/python#%E8%AE%BE%E5%A4%87%E5%BC%95%E8%84%9A%E5%B8%83%E5%B1%80)

ä¸»è¦ä½¿ç”¨ lgpio çš„ C åº“æ¥å®Œæˆç›¸åº”åŠŸèƒ½ï¼Œå®˜æ–¹æ–‡æ¡£ï¼šhttps://abyz.me.uk/lg/lgpio.html

#### å®‰è£…ä¾èµ–

```
sudo apt install liblgpio-dev python3-gpiozero
```

#### æ§åˆ¶LEDç¯

ç¡¬ä»¶è¿æ¥ï¼ˆä½¿ç”¨ SpacemiT MUSE Pi å¼€å‘æ¿ 70 å·å¼•è„šï¼‰ï¼š

![](./images/cppled.png)

ç¤ºä¾‹ä»£ç 

```c++
#include <stdio.h>
#include <unistd.h>
#include <lgpio.h>

int main(void)
{
    int h;       // èŠ¯ç‰‡å¥æŸ„
    int line = 70; // ä½ è¦æ§åˆ¶çš„ GPIO å¼•è„šå·
    int lh;      // line handle
    int i;

    // æ‰“å¼€ /dev/gpiochip0
    h = lgGpiochipOpen(0);
    if (h < 0)
    {
        printf("æ— æ³•æ‰“å¼€ gpiochip0: %d\n", h);
        return 1;
    }

    // ç”³è¯· GPIO70 è¾“å‡º
    lh = lgGpioClaimOutput(h, 0, line, 0); // åˆå§‹ä¸ºä½ç”µå¹³
    if (lh < 0)
    {
        printf("æ— æ³•ç”³è¯· GPIO%d è¾“å‡º: %d\n", line, lh);
        lgGpiochipClose(h);
        return 1;
    }

    // é—ªçƒ 10 æ¬¡
    for (i = 0; i < 10; i++)
    {
        lgGpioWrite(h, line, 1); // é«˜ç”µå¹³
        usleep(500000);          // å»¶æ—¶ 0.5 ç§’
        lgGpioWrite(h, line, 0); // ä½ç”µå¹³
        usleep(500000);
    }

    // é‡Šæ”¾ GPIO
    lgGpioFree(h, line);
    lgGpiochipClose(h);

    return 0;
}

```

ä¿å­˜ä¸ºï¼šblink.c

ç¼–è¯‘

```
gcc -o blink blink.c -llgpio
```

æ‰§è¡Œç¨‹åº

```
./blink
```

