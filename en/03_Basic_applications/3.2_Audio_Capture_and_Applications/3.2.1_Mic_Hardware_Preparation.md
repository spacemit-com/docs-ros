sidebar_position: 1

# Microphone Hardware Setup and Debugging

## Supported Hardware and Protocols

- **Hardware Interfaces**：
  - USB microphones
  - USB sound cards
  - On-board I²S microphones (availability depends on the board variant)
- **Protocols**：
  - ALSA (Advanced Linux Sound Architecture)
  - PulseAudio (optional, mainly for development and debugging)

## Software and Hardware Environment

- **Operating System**: ROS2_LXQT
- **Recommended Hardware**: SpacemiT **MUSE Pi Pro** development board
- **Common Tools (development and debugging)**:
  - `audioscan` (lists all available capture and playback devices)
  - `arecord` (ALSA command-line audio recording tool)
  - `aplay` (ALSA command-line audio playback tool)
  - `alsamixer` (command-line mixer for volume and gain control)

## Install System Dependencies

```bash
sudo apt install python3-pyaudio python3-scipy libfftw3-dev \
portaudio19-dev libsndfile1-dev libcurl4-openssl-dev espeak-ng
```

## Microphone Connection

Connect the USB microphone to one of the USB ports on the **MUSE Pi Pro** with

![](images/mic_connect.png)

## Add User to the Audio Group

By default, general user may not have permission to access audio devices.
Add the current user to the `audio` group:

```bash
sudo usermod -aG audio $USER
```

Then, log out and log back in for the group change to take effect.

## Identify the Audio Device

Use `audioscan` to list all available audio devices:

```bash
audioscan
```

Example output:

![](./images/audioscan.png)

Only **input devices** are relevant for recording; ignore output devices.

**Notes:**
- In this example, the USB microphone has a `device_index` of `2` (You can confirm the device by unplugging and replugging the microphone and observing the change.)
- The corresponding ALSA device identifier is **`hw:2,0`**.

## Check Supported Audio Frequency

```bash
arecord -D hw:2,0 --dump-hw-params
```

**Example output**

![](./images/arecord_out1.png)

Key Parameters Explained

```
--------------------
ACCESS:  MMAP_INTERLEAVED RW_INTERLEAVED 
# Data access modes:
# - RW_INTERLEAVED: Common mode where multi-channel audio data is stored interleaved (e.g., L, R, L, R...).
# - MMAP_INTERLEAVED: Memory-mapped access mode, offering better performance but with more complex usage.

FORMAT:  S16_LE               
# S16_LE: 16-bit signed integer, little-endian byte order (commonly used).

SUBFORMAT:  STD               
# Standard PCM (Pulse Code Modulation) format.

SAMPLE_BITS: 16               
# Number of bits per audio sample (16 bits).

FRAME_BITS: 16                
# Number of bits per audio frame. For mono audio, this is the same as SAMPLE_BITS (16 bits).

CHANNELS: 1                   
# Number of audio channels

RATE: [44100 48000]           
# Supported sample rates. This device supports 44.1 kHz and 48 kHz.

PERIOD_TIME: [1000 1000000]   
# Duration of a single period in microseconds (µs).

PERIOD_SIZE: [45 48000]       
# Number of frames per period. Minimum: 45 frames, Maximum: 48,000 frames.

PERIOD_BYTES: [90 96000]      
# Number of bytes per period. For 16-bit mono audio: PERIOD_SIZE × 2 bytes.

PERIODS: [2 1024]             
# Number of periods in the ring buffer. Minimum: 2 periods, Maximum: 1024 periods.

BUFFER_TIME: [1875 2000000]   
# Total buffer duration in microseconds (µs). Ranges from 1.875 ms to 2000 ms.

BUFFER_SIZE: [90 96000]       
# Total number of frames the buffer can hold.

BUFFER_BYTES: [180 192000]    
# Total buffer size in bytes. For 16-bit mono audio: BUFFER_SIZE × 2 bytes.

TICK_TIME: ALL                
# Timer resolution. ALL indicates no restriction; typically determined by the driver.
--------------------
```

In this guide, **48 kHz** is used.
(44.1 kHz is also acceptable, depending on application requirements.)

## Test Audio Recording

```bash
arecord -D hw:2,0 -f S16_LE -r 48000 -c 1 test.wav
```

If the command completes successfully, `test.wav` will contain the recorded audio and can be used for further validation or application testing.